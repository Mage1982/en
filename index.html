/* 2. RSS FEED MODUL (JAVÍTOTT YOUTUBE ÉS FACEBOOK) */
async function fetchAllFeeds() {
    const sources = [
        { 
            // Facebook feed az rss.app-on keresztül
            url: 'https://rss.app/feeds/hv8SSk6d10Wxx8Ow.xml', 
            type: 'fb', 
            label: 'Facebook' 
        },
        { 
            // YouTube feed a hivatalos XML forrásból
            url: 'https://www.youtube.com/feeds/videos.xml?channel_id=UC0Zp9e3y-Wz7S3N_n8t06sA', 
            type: 'yt', 
            label: 'Kontroll TV' 
        }
    ];

    const container = document.getElementById('news-container');
    let combinedItems = [];

    // Megpróbáljuk mindkét forrást betölteni
    for (const source of sources) {
        try {
            // Mindkét forrást átküldjük a konverteren a CORS hiba elkerülése végett
            const apiUrl = `https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(source.url)}&api_key=00000000000000000000000000000000`; // Az alap API kulcs néha segít
            
            const response = await fetch(apiUrl);
            const data = await response.json();

            if (data.status === 'ok') {
                const items = data.items.map(item => ({
                    ...item,
                    sourceType: source.type,
                    sourceLabel: source.label,
                    // Időbélyeg normalizálása az összehasonlításhoz
                    sortDate: new Date(item.pubDate).getTime()
                }));
                combinedItems = combinedItems.concat(items);
            }
        } catch (e) { 
            console.error("Hiba a betöltés során:", source.label, e); 
        }
    }

    // Időrendi sorrendbe rakás (legfrissebb legfelül)
    combinedItems.sort((a, b) => b.sortDate - a.sortDate);

    if (combinedItems.length > 0) {
        container.innerHTML = '';
        combinedItems.forEach(item => {
            const card = document.createElement('a');
            card.className = 'news-card';
            card.href = item.link;
            card.target = '_blank';

            // Képkezelés finomítása
            let img = '';
            if (item.sourceType === 'yt') {
                img = item.thumbnail; // YouTube API-nál ez fix helyen van
            } else {
                img = item.thumbnail || item.enclosure.link || '';
            }
            
            // Ha még mindig nincs kép, megpróbáljuk kikaparni a leírásból
            if(!img && item.description.includes('<img')) {
                const m = item.description.match(/src="([^"]+)"/);
                if(m) img = m[1];
            }
            
            const fallback = 'https://via.placeholder.com/400x250/f4f4f4/666666?text=Rendszerváltás+2026';

            card.innerHTML = `
                <div class="news-image" style="background-image: url('${img || fallback}')"></div>
                <div class="news-content">
                    <span class="badge ${item.sourceType === 'fb' ? 'badge-fb' : 'badge-yt'}">${item.sourceLabel}</span>
                    <h3>${item.title}</h3>
                    <p>${item.description.replace(/<[^>]*>/g, '').substring(0, 130)}...</p>
                    <span class="read-more">Megtekintés →</span>
                </div>
            `;
            container.appendChild(card);
        });
    } else {
        container.innerHTML = "<div id='loader'>Jelenleg nem sikerült betölteni a hírfolyamot. Kérjük, frissítsd az oldalt!</div>";
    }
}

fetchAllFeeds();
